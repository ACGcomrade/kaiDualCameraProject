# æ‘„åƒå¤´é€‰æ‹©å™¨å®Œå…¨é‡åš - ç®€åŒ–æ–¹æ¡ˆ - December 11, 2025

## é—®é¢˜æ€»ç»“

### åŸæ–¹æ¡ˆçš„é—®é¢˜ âŒ
1. **Session å†²çª** - ä¸» app å’Œé€‰æ‹©å™¨åŒæ—¶è¿è¡Œå¤šä¸ª AVCaptureSession
2. **SIGABRT å´©æºƒ** - å¤šä¸ª session è®¿é—®åŒä¸€æ‘„åƒå¤´ç¡¬ä»¶
3. **å¤æ‚åº¦é«˜** - éœ€è¦ç®¡ç†å¤šä¸ª session çš„ç”Ÿå‘½å‘¨æœŸ
4. **æŒ‰é’®ä½ç½®æ··ä¹±** - Capture æŒ‰é’®ä½ç½®ä¸å¯¹

## æ–°æ–¹æ¡ˆ âœ…

### æ ¸å¿ƒæ€è·¯
**ä¸ä½¿ç”¨å®æ—¶é¢„è§ˆï¼Œåªæ˜¾ç¤ºæ‘„åƒå¤´ä¿¡æ¯**

1. **åœæ­¢ä¸»é¢„è§ˆ** - æ‰“å¼€é€‰æ‹©å™¨æ—¶è°ƒç”¨åŒå‡»å†»ç»“çš„ method
2. **æ˜¾ç¤ºé™æ€å›¾æ ‡** - ä¸å¯åŠ¨æ–°çš„ AVCaptureSession
3. **æ¢å¤ä¸»é¢„è§ˆ** - å…³é—­é€‰æ‹©å™¨æ—¶æ¢å¤

### ä¼˜ç‚¹
- âœ… é›¶ session å†²çª
- âœ… ä¸ä¼šå´©æºƒ
- âœ… ç®€å•å¯é 
- âœ… æ€§èƒ½å¥½

---

## å®ç°æ–¹æ¡ˆ

### 1. æ–°å»º AllCamerasGridView.swift âœ¨

**æ–‡ä»¶**: `AllCamerasGridView.swift`

**åŠŸèƒ½**:
- æ£€æµ‹æ‰€æœ‰å¯ç”¨æ‘„åƒå¤´
- æ˜¾ç¤ºæ‘„åƒå¤´ä¿¡æ¯ï¼ˆåç§°ã€ç„¦è·ã€ç±»å‹ï¼‰
- **ä¸å¯åŠ¨å®æ—¶é¢„è§ˆ**ï¼ˆé¿å… session å†²çªï¼‰
- ä½¿ç”¨é™æ€å›¾æ ‡ä»£æ›¿å®æ—¶ç”»é¢

**å…³é”®ä»£ç **:
```swift
struct AllCamerasGridView: View {
    @ObservedObject var viewModel: CameraViewModel
    @State private var cameras: [CameraDeviceInfo] = []
    
    var body: some View {
        // æ˜¾ç¤ºæ‰€æœ‰æ‘„åƒå¤´ä¿¡æ¯ï¼Œä¸å¯åŠ¨é¢„è§ˆ
        ForEach(cameras) { camera in
            CameraInfoCard(camera: camera)
        }
    }
}
```

**CameraInfoCard**:
```swift
struct CameraInfoCard: View {
    let camera: CameraDeviceInfo
    
    var body: some View {
        // é™æ€å›¾æ ‡ + ä¿¡æ¯
        VStack {
            Image(systemName: iconName)  // å›¾æ ‡ï¼Œä¸æ˜¯å®æ—¶é¢„è§ˆ
            Text(camera.displayName)
            Text(camera.focalLength)
        }
    }
}
```

**å›¾æ ‡æ˜ å°„**:
- Ultra Wide â†’ `arrow.down.left.and.arrow.up.right`
- Wide â†’ `camera.fill`
- Telephoto â†’ `arrow.up.left.and.arrow.down.right`
- Front â†’ `camera.fill`

---

### 2. æ›´æ–° ContentView.swift ğŸ”§

**Sheet é…ç½®**:
```swift
.sheet(isPresented: $showCameraSelector) {
    AllCamerasGridView(viewModel: viewModel)
        .onAppear {
            // åœæ­¢ä¸»é¢„è§ˆï¼ˆè°ƒç”¨åŒå‡»å†»ç»“çš„methodï¼‰
            if viewModel.uiVisibilityManager.isPreviewVisible {
                viewModel.toggleCameraSession()
            }
        }
        .onDisappear {
            // æ¢å¤ä¸»é¢„è§ˆ
            if !viewModel.uiVisibilityManager.isPreviewVisible {
                viewModel.toggleCameraSession()
            }
        }
}
```

**å·¥ä½œæµç¨‹**:
1. ç”¨æˆ·ç‚¹å‡»æ‘„åƒå¤´é€‰æ‹©æŒ‰é’®
2. `onAppear` è§¦å‘ï¼Œè°ƒç”¨ `toggleCameraSession()` åœæ­¢ä¸» camera
3. æ˜¾ç¤ºæ‘„åƒå¤´ä¿¡æ¯åˆ—è¡¨ï¼ˆé™æ€å›¾æ ‡ï¼‰
4. ç”¨æˆ·ç‚¹å‡»"å®Œæˆ"
5. `onDisappear` è§¦å‘ï¼Œè°ƒç”¨ `toggleCameraSession()` æ¢å¤ä¸» camera

---

### 3. æŒ‰é’®ä½ç½®ä¿®å¤ ğŸ”§

**æ¨ªå±å¸ƒå±€**:
```swift
VStack(spacing: 0) {
    Spacer().frame(height: 60)  // é¡¶éƒ¨ç•™ç©º
    
    // Camera selector button - é¡¶éƒ¨
    if viewModel.uiVisibilityManager.isUIVisible {
        Button("æ‘„åƒå¤´é€‰æ‹©") { ... }
    }
    
    Spacer()  // å‚ç›´å±…ä¸­
    
    // Capture button - å±…ä¸­
    Button("Capture") { ... }
    
    Spacer()  // å‚ç›´å±…ä¸­
    
    // è¾…åŠ©æŒ‰é’® - åº•éƒ¨
    HStack {
        Button("Flash") { ... }
        Button("Mode") { ... }
        Button("Gallery") { ... }
    }
}
```

**å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               [Cam]     â”‚ â† æ‘„åƒå¤´é€‰æ‹©æŒ‰é’® (é¡¶éƒ¨)
â”‚                         â”‚
â”‚                [Cap]    â”‚ â† Capture (å‚ç›´å±…ä¸­)
â”‚                         â”‚
â”‚          [F][M][G]      â”‚ â† è¾…åŠ©æŒ‰é’® (åº•éƒ¨)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç«–å±å¸ƒå±€**:
- æ‘„åƒå¤´é€‰æ‹©æŒ‰é’®ï¼šå·¦ä¸Šè§’ï¼ˆç‹¬ç«‹å±‚ï¼‰
- å…¶ä»–æŒ‰é’®ï¼šåº•éƒ¨

---

## ä¸ä¹‹å‰æ–¹æ¡ˆçš„å¯¹æ¯”

### ä¹‹å‰çš„æ–¹æ¡ˆ âŒ

**ç‰¹ç‚¹**:
- æ¯ä¸ªæ‘„åƒå¤´å¯åŠ¨ä¸€ä¸ª AVCaptureSession
- æ˜¾ç¤ºå®æ—¶é¢„è§ˆç”»é¢
- å¤æ‚çš„ session ç®¡ç†

**é—®é¢˜**:
```
ä¸» app: AVCaptureMultiCamSession (åç½® + å‰ç½®)
         â†“
é€‰æ‹©å™¨: AVCaptureSession Ã— 4
         â†“
å†²çªï¼SIGABRT å´©æºƒ
```

### æ–°æ–¹æ¡ˆ âœ…

**ç‰¹ç‚¹**:
- ä¸å¯åŠ¨ä»»ä½•æ–° session
- æ˜¾ç¤ºé™æ€å›¾æ ‡å’Œä¿¡æ¯
- ç®€å•çš„çŠ¶æ€ç®¡ç†

**æµç¨‹**:
```
ä¸» app: AVCaptureMultiCamSession è¿è¡Œä¸­
         â†“
æ‰“å¼€é€‰æ‹©å™¨ â†’ åœæ­¢ä¸» session
         â†“
é€‰æ‹©å™¨: åªæ˜¾ç¤ºä¿¡æ¯ï¼ˆæ—  sessionï¼‰
         â†“
å…³é—­é€‰æ‹©å™¨ â†’ æ¢å¤ä¸» session
```

**æ— å†²çªï¼** âœ…

---

## ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶
1. âœ… **AllCamerasGridView.swift** - æ–°çš„ç®€åŒ–æ‘„åƒå¤´åˆ—è¡¨

### ä¿®æ”¹æ–‡ä»¶
1. âœ… **ContentView.swift** 
   - æ›¿æ¢ `CameraSelectorView` ä¸º `AllCamerasGridView`
   - æ·»åŠ  onAppear/onDisappear æ§åˆ¶ä¸» session
   - ä¿®å¤æ¨ªå±æŒ‰é’®å¸ƒå±€
   - æ·»åŠ ç«–å±æ‘„åƒå¤´é€‰æ‹©æŒ‰é’®

### ä¸å†éœ€è¦çš„æ–‡ä»¶
1. â­ï¸  **CameraSelectorView.swift** - å¯ä»¥åˆ é™¤ï¼ˆä¸ä½¿ç”¨äº†ï¼‰
2. â­ï¸  **CameraSelectorViewModel** - ä¸éœ€è¦å¤æ‚çš„ ViewModel

---

## åŠŸèƒ½è¯´æ˜

### æ‘„åƒå¤´ä¿¡æ¯æ˜¾ç¤º

**æ¯ä¸ªæ‘„åƒå¤´æ˜¾ç¤º**:
- ğŸ“· å›¾æ ‡ï¼ˆæ ¹æ®ç±»å‹ï¼‰
- ğŸ“ åç§°ï¼ˆåç½® è¶…å¹¿è§’ / å‰ç½® åŸæ·±æ„Ÿï¼‰
- ğŸ“ ç„¦è·ï¼ˆ0.5x (13mm) / 1x (26mm) / 2x (52mm)ï¼‰
- ğŸ·ï¸  ç±»å‹ï¼ˆUltra Wide / Wide / Telephotoï¼‰

**ç¤ºä¾‹**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ“·                â”‚ â† è¶…å¹¿è§’å›¾æ ‡
â”‚   åç½® è¶…å¹¿è§’         â”‚
â”‚   0.5x (13mm)       â”‚
â”‚   Ultra Wide        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ“·                â”‚ â† å¹¿è§’å›¾æ ‡
â”‚   åç½® å¹¿è§’          â”‚
â”‚   1x (26mm)         â”‚
â”‚   Wide              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç”¨æˆ·ä½“éªŒæµç¨‹

### åœºæ™¯ 1: æŸ¥çœ‹æ‘„åƒå¤´åˆ—è¡¨

**æ­¥éª¤**:
1. ç”¨æˆ·ç‚¹å‡»æ‘„åƒå¤´é€‰æ‹©æŒ‰é’®ï¼ˆç«–å±å·¦ä¸Šè§’ / æ¨ªå±å³ä¾§é¡¶éƒ¨ï¼‰
2. ä¸» camera åœæ­¢ï¼ˆç”»é¢å†»ç»“ï¼‰
3. å¼¹å‡ºæ‘„åƒå¤´åˆ—è¡¨
4. æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨æ‘„åƒå¤´ï¼ˆé™æ€å›¾æ ‡ + ä¿¡æ¯ï¼‰
5. ç”¨æˆ·æµè§ˆä¿¡æ¯
6. ç‚¹å‡»"å®Œæˆ"å…³é—­
7. ä¸» camera æ¢å¤è¿è¡Œ

**æ—¶é—´**: < 0.5 ç§’ï¼ˆæ—  session å¯åŠ¨å»¶è¿Ÿï¼‰

### åœºæ™¯ 2: å¿«é€Ÿå¼€å…³

**æ­¥éª¤**:
1. æ‰“å¼€é€‰æ‹©å™¨
2. ç«‹å³ç‚¹å‡»"å®Œæˆ"
3. æ— å´©æºƒï¼Œæµç•…åˆ‡æ¢

**åŸå› **: æ²¡æœ‰ session éœ€è¦å¯åŠ¨/åœæ­¢

---

## æŠ€æœ¯è¦ç‚¹

### 1. ä½¿ç”¨ toggleCameraSession() æ–¹æ³•

**ä¼˜ç‚¹**:
- å¤ç”¨ç°æœ‰çš„åŒå‡»å†»ç»“é€»è¾‘
- ä¸éœ€è¦æ–°çš„ API
- å·²ç»æµ‹è¯•è¿‡ï¼Œç¨³å®šå¯é 

**ä»£ç **:
```swift
// åœæ­¢ä¸» camera
viewModel.toggleCameraSession()

// UIVisibilityManager å†…éƒ¨:
func toggleCameraSession() {
    isPreviewVisible.toggle()
    if isPreviewVisible {
        cameraManager.setupSession()
    } else {
        cameraManager.stopSession()
    }
}
```

### 2. é™æ€å›¾æ ‡ vs å®æ—¶é¢„è§ˆ

**ä¸ºä»€ä¹ˆé€‰æ‹©é™æ€å›¾æ ‡**:
- âœ… é›¶ session å†²çª
- âœ… ç¬æ—¶æ˜¾ç¤º
- âœ… ä½åŠŸè€—
- âœ… ä¿¡æ¯æ¸…æ™°

**ç”¨æˆ·æ˜¯å¦éœ€è¦å®æ—¶é¢„è§ˆ**:
- âŒ ä¸éœ€è¦ï¼ç”¨æˆ·åªæƒ³çŸ¥é“è®¾å¤‡ä¸Šæœ‰å“ªäº›æ‘„åƒå¤´
- âœ… å›¾æ ‡ + åç§° + ç„¦è·å·²ç»è¶³å¤Ÿ

### 3. Session ç”Ÿå‘½å‘¨æœŸ

**ä¹‹å‰ï¼ˆå¤æ‚ï¼‰**:
```
ä¸» session: [è¿è¡Œä¸­]
     â†“
é€‰æ‹©å™¨ session 1: å¯åŠ¨ä¸­...
é€‰æ‹©å™¨ session 2: å¯åŠ¨ä¸­...
é€‰æ‹©å™¨ session 3: å¯åŠ¨ä¸­...
é€‰æ‹©å™¨ session 4: å¯åŠ¨ä¸­...
     â†“
å†²çªï¼å´©æºƒ
```

**ç°åœ¨ï¼ˆç®€å•ï¼‰**:
```
ä¸» session: [è¿è¡Œä¸­]
     â†“
     åœæ­¢
     â†“
é€‰æ‹©å™¨: (æ—  session)
     â†“
     æ¢å¤
     â†“
ä¸» session: [è¿è¡Œä¸­]
```

---

## æµ‹è¯•æ¸…å•

### Test 1: åŸºæœ¬åŠŸèƒ½ âœ…
- [ ] æ‰“å¼€é€‰æ‹©å™¨ï¼Œä¸» camera åœæ­¢
- [ ] æ˜¾ç¤ºæ­£ç¡®æ•°é‡çš„æ‘„åƒå¤´ï¼ˆ4 ä¸ªï¼‰
- [ ] æ˜¾ç¤ºæ­£ç¡®çš„åç§°å’Œç„¦è·
- [ ] ç‚¹å‡»"å®Œæˆ"ï¼Œä¸» camera æ¢å¤
- [ ] æ— å´©æºƒ

### Test 2: å¿«é€Ÿæ“ä½œ âœ…
- [ ] å¿«é€Ÿæ‰“å¼€/å…³é—­é€‰æ‹©å™¨ï¼ˆ10 æ¬¡ï¼‰
- [ ] æ— å¡é¡¿
- [ ] æ— å´©æºƒ

### Test 3: æŒ‰é’®ä½ç½® âœ…
**ç«–å±**:
- [ ] æ‘„åƒå¤´é€‰æ‹©æŒ‰é’®åœ¨å·¦ä¸Šè§’

**æ¨ªå±**:
- [ ] æ‘„åƒå¤´é€‰æ‹©æŒ‰é’®åœ¨å³ä¾§é¡¶éƒ¨
- [ ] Capture æŒ‰é’®å‚ç›´å±…ä¸­
- [ ] è¾…åŠ©æŒ‰é’®åœ¨åº•éƒ¨

### Test 4: å½•åˆ¶æ—¶æ“ä½œ âœ…
- [ ] å¼€å§‹å½•åˆ¶
- [ ] æ‰“å¼€é€‰æ‹©å™¨ï¼ˆä¸» camera åœæ­¢ï¼‰
- [ ] å½•åˆ¶ç»§ç»­ï¼ˆåå°å¤„ç†ï¼‰
- [ ] å…³é—­é€‰æ‹©å™¨
- [ ] å½•åˆ¶æ­£å¸¸
- [ ] æ— å´©æºƒ

### Test 5: æ–¹å‘åˆ‡æ¢ âœ…
- [ ] ç«–å±æ‰“å¼€é€‰æ‹©å™¨
- [ ] æ—‹è½¬åˆ°æ¨ªå±
- [ ] æŒ‰é’®ä½ç½®æ­£ç¡®
- [ ] å…³é—­é€‰æ‹©å™¨
- [ ] æ— å´©æºƒ

---

## Console æ—¥å¿—

### æ­£å¸¸æµç¨‹:
```
ğŸ–ï¸ Camera selector button tapped
ğŸ“± toggleCameraSession() called
ğŸ“· Stopping camera session...
ğŸ“· AllCamerasGridView: Found 4 cameras
   âœ… åç½® è¶…å¹¿è§’ - 0.5x (13mm)
   âœ… åç½® å¹¿è§’ - 1x (26mm)
   âœ… åç½® é•¿ç„¦ - 2x (52mm)
   âœ… å‰ç½® åŸæ·±æ„Ÿ - 1x (å‰ç½®)
[ç”¨æˆ·æµè§ˆ]
ğŸ–ï¸ å®Œæˆ button tapped
ğŸ“± toggleCameraSession() called
ğŸ“· Starting camera session...
âœ… Camera resumed
```

### å¼‚å¸¸ç›‘æ§:
- âŒ SIGABRT - ä¸åº”è¯¥å‡ºç°ï¼ˆæ—  session å†²çªï¼‰
- âš ï¸  Session å¯åŠ¨å¤±è´¥ - å¯èƒ½å‡ºç°ï¼Œä½†ä¸ä¼šå´©æºƒ

---

## ä¼˜åŠ¿æ€»ç»“

### ä¹‹å‰æ–¹æ¡ˆçš„é—®é¢˜
1. âŒ å¤æ‚çš„ session ç®¡ç†
2. âŒ å®¹æ˜“å´©æºƒï¼ˆSIGABRTï¼‰
3. âŒ å¯åŠ¨å»¶è¿Ÿï¼ˆç­‰å¾… sessionï¼‰
4. âŒ é«˜åŠŸè€—ï¼ˆå¤šä¸ª sessionï¼‰
5. âŒ éš¾ä»¥è°ƒè¯•

### æ–°æ–¹æ¡ˆçš„ä¼˜åŠ¿
1. âœ… æç®€å®ç°ï¼ˆ< 150 è¡Œä»£ç ï¼‰
2. âœ… é›¶å´©æºƒé£é™©
3. âœ… ç¬æ—¶æ˜¾ç¤ºï¼ˆæ— å»¶è¿Ÿï¼‰
4. âœ… ä½åŠŸè€—ï¼ˆæ—  sessionï¼‰
5. âœ… æ˜“äºç»´æŠ¤

### å…³é”®æ´å¯Ÿ
**ç”¨æˆ·éœ€è¦çš„æ˜¯ä¿¡æ¯ï¼Œä¸æ˜¯å®æ—¶é¢„è§ˆ**
- è®¾å¤‡ä¸Šæœ‰å“ªäº›æ‘„åƒå¤´ï¼Ÿ
- å®ƒä»¬çš„ç„¦è·æ˜¯å¤šå°‘ï¼Ÿ
- å®ƒä»¬çš„ç±»å‹æ˜¯ä»€ä¹ˆï¼Ÿ

è¿™äº›ä¿¡æ¯ç”¨é™æ€å›¾æ ‡å’Œæ–‡å­—å®Œå…¨å¯ä»¥è¡¨è¾¾ï¼Œä¸éœ€è¦å®æ—¶é¢„è§ˆã€‚

---

## æœªæ¥å¯èƒ½çš„å¢å¼º

### 1. æ‘„åƒå¤´åˆ‡æ¢åŠŸèƒ½ ğŸ”®
```swift
CameraInfoCard(camera: camera)
    .onTapGesture {
        // åˆ‡æ¢åˆ°è¯¥æ‘„åƒå¤´
        viewModel.switchToCamera(camera)
        dismiss()
    }
```

### 2. æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„æ‘„åƒå¤´ ğŸ”®
```swift
if camera.id == viewModel.currentCameraID {
    Image(systemName: "checkmark.circle.fill")
}
```

### 3. æ›´å¤šæ‘„åƒå¤´ä¿¡æ¯ ğŸ”®
- æ”¯æŒçš„åˆ†è¾¨ç‡
- æœ€å¤§å¸§ç‡
- HDR æ”¯æŒ
- å¤œé—´æ¨¡å¼

---

## æ€»ç»“

âœ… **å®Œå…¨é‡åšï¼Œé‡‡ç”¨ç®€åŒ–æ–¹æ¡ˆ**:
1. âœ… ä¸ä½¿ç”¨å®æ—¶é¢„è§ˆï¼Œæ˜¾ç¤ºé™æ€å›¾æ ‡
2. âœ… åˆ©ç”¨ toggleCameraSession() åœæ­¢/æ¢å¤ä¸» camera
3. âœ… é›¶ session å†²çªï¼Œä¸ä¼šå´©æºƒ
4. âœ… æŒ‰é’®ä½ç½®ä¿®å¤ï¼ˆæ¨ªå±é¡¶éƒ¨ï¼Œç«–å±å·¦ä¸Šï¼‰
5. âœ… æç®€ä»£ç ï¼Œæ˜“äºç»´æŠ¤

**å…³é”®æ”¹è¿›**: è®¤è¯†åˆ°ç”¨æˆ·éœ€è¦çš„æ˜¯**ä¿¡æ¯**è€Œä¸æ˜¯**å®æ—¶é¢„è§ˆ**ï¼Œä»æ ¹æœ¬ä¸Šç®€åŒ–äº†å®ç°ã€‚ğŸ‰
