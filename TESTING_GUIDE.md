# 测试指南 - 屏幕录制PIP模式

## 🎯 测试目标
验证新的屏幕录制实现是否解决了PIP位置问题，并且功能正常。

## 📋 测试准备

### 1. 设备要求
- 支持多摄像头的iPhone（iPhone XS及以上）
- iOS 13.0+

### 2. 权限检查
确保应用已获得以下权限：
- 📷 相机权限
- 🎤 麦克风权限
- 📁 照片库权限

## 🧪 测试用例

### A. PIP照片拍摄测试

#### 测试1：基本PIP照片
1. 打开应用，选择 **PIP模式**
2. 预览应显示：
   - 主画面：后置摄像头（全屏）
   - PIP小窗：前置摄像头（右上角）
3. 点击拍照按钮 📸
4. **验证**：保存的照片中PIP应该在 **右上角**

#### 测试2：横屏PIP照片
1. 旋转设备到横屏模式
2. 等待UI适应新方向
3. 点击拍照
4. **验证**：横屏照片中PIP位置正确

#### 测试3：闪光灯PIP照片
1. 开启闪光灯（常亮或自动）
2. 点击拍照
3. **验证**：
   - 闪光灯正常工作
   - PIP位置在右上角
   - 照片正常保存

#### 预期结果
✅ 所有照片的PIP都应该在 **右上角**（不是右下角）
✅ PIP显示的内容与预览完全一致
✅ 照片自动保存到相册

### B. PIP视频录制测试

#### 测试4：基本PIP视频
1. 进入PIP模式
2. 点击录制按钮 🔴
3. 录制5-10秒
4. 停止录制
5. **验证**：
   - 视频中PIP始终在右上角
   - PIP内容清晰可见
   - 音频正常录制

#### 测试5：不同帧率测试
1. 进入设置，修改帧率：
   - 15 fps
   - 24 fps  
   - 30 fps
2. 每个帧率录制一段视频
3. **验证**：
   - 所有帧率都能正常录制
   - PIP位置始终正确
   - 视频流畅无卡顿

#### 测试6：长时间录制
1. 开始录制
2. 录制1-2分钟
3. 停止录制
4. **验证**：
   - CPU温度正常（不过热）
   - 内存使用稳定
   - 视频完整保存
   - 音频同步

#### 测试7：录制中移动设备
1. 开始录制
2. 缓慢移动设备（前后左右）
3. 停止录制
4. **验证**：
   - PIP位置保持固定在右上角
   - 画面稳定
   - 没有异常抖动

#### 预期结果
✅ 视频中PIP始终在右上角
✅ 帧率稳定，与设置匹配
✅ 音频视频同步
✅ 长时间录制性能稳定

### C. 性能测试

#### 测试8：CPU使用率
1. 打开PIP模式
2. 开始录制
3. 使用Xcode Instruments监控CPU
4. **验证**：
   - CPU使用率应该 < 60%（屏幕录制比帧合成更轻量）
   - 无过热

#### 测试9：内存占用
1. 录制多段视频
2. 监控内存使用
3. **验证**：
   - 内存稳定增长
   - 停止录制后内存释放
   - 无内存泄漏

### D. 边界情况测试

#### 测试10：快速操作
1. 快速点击拍照按钮（连拍）
2. **验证**：
   - 不崩溃
   - 每张照片都保存
   - PIP位置一致

#### 测试11：模式切换
1. PIP模式 → 拍照
2. 切换到双录模式 → 录制
3. 切换回PIP模式 → 拍照
4. **验证**：
   - 切换流畅无卡顿
   - 功能正常工作

#### 测试12：后台恢复
1. 开始录制
2. 切换到后台（Home键）
3. 等待5秒
4. 返回应用
5. **验证**：
   - 录制自动停止（iOS限制）
   - 应用恢复正常
   - 可以重新录制

## 🐛 已知问题检查清单

### 问题1：PIP在右下角（已修复）
- [ ] 竖屏照片：PIP应在右上角 ✓
- [ ] 横屏照片：PIP应在右上角 ✓
- [ ] 视频：PIP始终在右上角 ✓

### 问题2：坐标系统错误（已修复）
- [ ] 不再需要手动坐标转换 ✓
- [ ] 使用屏幕录制，自动正确 ✓

### 问题3：帧率不同步（已修复）
- [ ] 录制帧率 = 设置的帧率 ✓
- [ ] 显示流畅，无掉帧 ✓

## 📊 测试结果记录

### 测试设备信息
- 设备型号：_________
- iOS版本：_________
- 测试日期：_________

### 测试结果汇总

| 测试用例 | 通过 | 失败 | 备注 |
|---------|------|------|------|
| 测试1：基本PIP照片 | ☐ | ☐ | |
| 测试2：横屏PIP照片 | ☐ | ☐ | |
| 测试3：闪光灯PIP照片 | ☐ | ☐ | |
| 测试4：基本PIP视频 | ☐ | ☐ | |
| 测试5：不同帧率 | ☐ | ☐ | |
| 测试6：长时间录制 | ☐ | ☐ | |
| 测试7：录制中移动 | ☐ | ☐ | |
| 测试8：CPU使用率 | ☐ | ☐ | |
| 测试9：内存占用 | ☐ | ☐ | |
| 测试10：快速操作 | ☐ | ☐ | |
| 测试11：模式切换 | ☐ | ☐ | |
| 测试12：后台恢复 | ☐ | ☐ | |

## 🔍 调试日志

### 关键日志标记
查找以下日志确认屏幕录制正常工作：

```
✅ PreviewCaptureManager: Preview view set
✅ OptimizedDualCameraPreview: Connected to PreviewCaptureManager
📸 CameraManager: capturePIPPhoto - capturing preview screen (NEW METHOD)
🎥 CameraManager: startPIPVideoRecording - SCREEN CAPTURE MODE
✅ CameraManager: Screen capture timer started
```

### 如果看到以下错误
```
❌ CameraManager: Failed to capture screen frame
⚠️ PreviewCaptureManager: Preview view not set
```
→ 预览视图未正确连接到PreviewCaptureManager

## ✅ 成功标准

测试通过需满足：
1. ✅ **100%的照片** PIP都在右上角
2. ✅ **100%的视频** PIP都在右上角
3. ✅ 所有帧率设置都工作正常
4. ✅ 长时间录制稳定，无内存泄漏
5. ✅ CPU使用率合理（< 60%）
6. ✅ 无崩溃或卡死

## 🎉 预期改进

与旧版本比较，应该看到：
- ✅ PIP位置100%准确（之前经常出错）
- ✅ 代码更简单（不再有复杂坐标转换）
- ✅ 性能更好（CPU负载降低）
- ✅ 功能更强（为预览切换奠定基础）

## 📝 反馈

测试后请记录：
1. 是否所有测试通过？
2. 发现的任何问题
3. 性能表现如何？
4. 用户体验改进程度

---

**测试完成后，请将此文档连同测试结果一起保存。**
